# 第三章 表单设计 - 概述

## biForm 中“表单”的概念

用 biForm 开发应用程序， 一个最基础的概念就是“表单”。使用 biForm 需要遵循一定的应用框架，这个应用框架的核心就是  “一切都是表单”。在 biForm 的应用框架中，这些表单都被称为“PFF”即“portable form file”的缩写。

biForm 的核心理念是提供一种“高内聚低耦合的应用模式”。

开发者只需要将应用程序的各项功能拆分成一个个表单，单独进行开发和发布，就可以在我们提供的各种运行时环境中，实现任意表单的即插即用和自由组合。

biForm 中的表单与我们常听到的“电子表单”概念上有所不同。通常我们将“销售订单”、“意见收集表”、 “参会报名表”这类用于填写数据的应用称为“电子表单”，但不会把“资产负债表”、“进度看板”、“批量导入工具”等称之为表单。但在 biForm 中，这些都被称为表单。只要是一个有独立的图形界面的、包含一些脚本可以执行的，都被称之为“表单”。

在 biForm 中，一个表单是需要符合一定的规范要求的，在面对一项开发需求时，了解这些规范要求有助于设计出充分利用PFF特性并能达到快速开发目的的应用程序。

所以，有以下几个关键性的设计原则需要在开发前事先了解一下。

### 一：一个表单有且仅有一个可设计的图形化界面

biForm 中的表单是必须有图形化界面的，biForm通常并不是用于开发无界面应用的。但在运行状态下，一个表单未必是“可见”的，图形界面也许并不会显示出来，这取决于运行时引擎如何处理和使用这些表单。看不见的表单也只表示这个表单的图形界面在运行时没有显示，在设计时，它还是有图形化界面的，比如用于格式化打印的表单就属于这种类型。

表单通常会在运行时环境的主窗口里以子窗口形式显示，但也可以以弹出对话框的形式显示，在特殊情况下（比如做为格式化打印的表单）也有可能以隐藏的方式加载。

biForm 中一个表单只能有一个可以用可视化设计工具设计的图形化界面。但在一个表单中也可以调用系统提供的各种弹出对话框、调用其它表单做为弹出对话框，也可以用脚本调用和显示其它窗体。但不管如何调用外部的窗体控件，每个表单都是有且只有一个可设计的图形化界面，这个主要的图形界面是这个表单所有功能的入口，如果有其它需要显示的窗体可以通过 Python 脚本来创建和显示，但不能进行可视化设计。以后版本的  biForm 也许会增加支持一个表单上设计多个界面的功能。

所以，在设计一个应用程序时，按每个功能模块的主界面来分拆是比较容易有效的方法。

### 二：尽量使用 biForm 提供的数据视图功能访问数据源能获得更多好处

如果一个表单需要读写数据库中的数据，比如填写“报名表”后保存数据、或读取“工资数据”进行统计分析，我们都建议开发者尽量优先使用 biForm 提供的数据视图来完成对数据库的访问。

基于PFF的应用框架提供了跨平台、跨数据库、易于扩展、易于集成的数据库功能。如果开发者使用自己的方法来实现数据库的读写操作，很容易会失去这些特性，或者要为提供这些特性增加更多的开发工作量。

我们一般建议，只有在需要访问外部数据源与其它系统进行集成、无法使用 biForm 提供的数据视图等特殊情况时才需要自己去实现数据库访问的问题。与数据库开发相关的技巧请参考[第四章 数据库](4-1-summary)。

虽然 biForm 提供了 “数据视图”的功能，但一个表单并不是必须要使用数据库。表单也可以不使用数据视图的功能，这个并不是强制的。但所有表单在运行时，运行时引擎后台必然是有数据库的，因为做为一个通用的运行时引擎需要为其它表单提供底层的支持。如果表单本身没有需要读写数据库的需求，就不需要使用“数据视图”这项功能。但它运行时也还是在数据库环境下在运行，只是不需要“显式地”使用数据库。但即使不使用“数据视图”，表单也还是可以通过API接口读写数据库，或者创建数据库连接访问其它数据源。

目前 biReader 启动后只连接到一个数据源（称之为主数据源），即所有PFF表单都使用的是主数据源。但这只是目前 biReader 的设计模式，不排除以后支持多个数据源的可能性。即使是这样，在 biReader 中运行的表单也是有多种方式可以访问主数据源之外的其它数据源的。详细资料请参考[第四章 数据库](4-1-summary)的相关内容。

### 三：以降低耦合度的原则来开发应用程序和设计表单

初用 biForm 大家都能看到，在 biForm 中一次只能设计一个表单。不象其它IDE有“工程项目资源管理器”等工具，可能很多人会不适应。但这个其实是 biForm 的设计理念，希望开发者尽量以低耦合的思路来设计和开发一个表单。如果有一个“工程项目资源管理器”，以通常的思路，开发者就会想在项目内共用一些文件、复用一些代码、互相调用一下、加一个主函数入口，但这些都是 PFF 的应用框架想要避免的，因为这些操作都很容易增加各个表单之间的耦合度。

我们需要牢记每个表单都需要是“能独立运行的”，也即是它不能因为依赖于其它表单而“不能运行”。

“不能运行”指的是脚本运行出错等完全不能使用的情况。有时，我们的一个表单读取的数据是由其它表单输入后保存的数据，如果没有这些数据程序运行就得不到预期的效果，但程序运行并不会出错，这个不算是“不能运行”，耦合度也不高，因为并没有在运行状态下互相依赖。

我们也需要避免在一个表单中直接访问另一表单中的对象或数据，避免依赖于其它表单中的变量、常量、函数、类定义、数据结构、控件。通过使用 PFF 的运行时引擎提供的API、通过数据库中的数据表、通过系统参数表等等寻求低耦合度的解决方案，会更有利于保持表单间的低耦合。

我们需要尽量避免将思路局限在某个特定的“工程项目”中，因为 biForm 的目标是开发者开发的 PFF 也容易被其它开发者集成进自己的系统中、容易由用户自己对PFF进行组合。当然这些建立在原开发者愿意发布的前提下，但如果开发者在开发自己的应用程序时，以耦合度较高的方式实现功能，希望对外发布的时候，会需要重做功课进行解耦的操作，不如一开始就基于低耦合的原则来设计自己的应用程序和表单，这样才能充分发挥基于 PFF 应用平台的优势。

## 运行时环境

PFF的运行时环境可以是多种应用程序。比如我们发布的通用的运行时环境是 biReader ，还有一些特定的应用程序，比如工资核算管理系统、用于嵌入式开发的集成开发环境等。它们都是一个完整的应用程序，都包含了PFF运行时引擎，所以都可称之为“**PFF的运行时环境**”。虽然它们有不同的用途，但统一的特点都是：**主体程序者是用 Qt 开发的，都支持PFF的即插即用**。

所谓的“**支持PFF的即插即用**”，指在应用程序中可以加载PFF文件用于扩展主应用程序的功能。比如工资核算管理系统这类应用程序，通常我们会发布一个标准版本，其中已经包含了一些PFF文件，已经能提供完整的工资管理的功能了。但有些客户有个性化需求，那就可以通过添加或者替换标准版本中的某些PFF来满足自己的个性化需求。在嵌入式开发的集成开发环境的这个例子中，PFF也是做为扩展组件（或称为插件）对IDE的功能加以扩展。

PFF与其它一些用于开发过程的组件化或模块化的解决方案不同的是，PFF是在用户处进行“组装”的。

## biForm 适合开发什么样的应用程序

biForm 提供了 Qt 库和 Python基础库及很多Python第三方库，也支持开发者自己添加更多的第三方库。所以从这个角度上讲，biForm能利用 Qt 和 Python 强大的功能和库实现很多应用程序的功能。

但因为 biForm 基于一种低耦合的应用框架，所以那些内部功能之间耦合程度比较高、不适合对界面和功能进行拆分的应用程序就不适合用 biForm 来开发。

PFF本质上是文本文件，需要先加载和解析后才能使用，不适合把它做成一个特别大的单个文件，否则加载速度可能会不理想。虽然理论上讲，将一个大的应用程序完全塞进一个表单中也是可以实现的，但这样不方便开发，也不方便进行测试和调试，不管从哪个方面讲都不是一个好的选择。比如用 biForm 开发出一个 biForm 或 WPS 这种代码量的应用程序，就不合适。

还有一类应用程序，比如单机游戏，通常只有一个窗口，通过在这个窗口内切换场景来实现程序的各种功能。这一点与PFF在运行时，每个表单有一个子窗口或对话框的情况不符合，所以目前也不适合用 biForm 来开发。但如果只是一个小游戏，一个表单就能实现并且生成的文件不会过于庞大，倒是可以试试。

总结一下，耦合度较高、单个文件很大、不能套用PFF的窗口显示的方式的应用程序，就不太适合用 biForm 来实现。但也并不表示 biForm 就不能用于这类应用程序。如果用 Qt 开发主体程序，用 biForm 开发的PFF做为这类应用程序的扩展组件（或称插件），也是一种很好的选择。

目前我们的实践中，biForm很适合开发以下这些应用程序：

1.  各类数据库应用

这类软件包括各类管理软件、需要通过数据库存取数据的小应用、对数据进行统计分析的工具等等。这类软件通常很容易拆分成一个个低耦合度的表单。我们在实践中已经有大量这类应用采用 biForm 进行开发，实施和运行效果都很好。

2.  需要快速开发的小应用

biForm使用Python本身就很适用于这类需要快速实现的小应用。biForm提供了可视化的界面设计工具，而且很容易打包发布，很容易跨平台和使用数据库，所以相对于同样使用 Python 的基于 PyQt 或 wxWidgets 的解决方案，会是更好的选择。

3.  为其它应用开发扩展组件（或称插件）

如果您有用 Qt 开发的应用程序，希望能支持插件，就很适合使用基于PFF的解决方案。将PFF的运行时引擎加入您的代码中，您的应用程序就有了一个插件体系，biForm 开发的PFF就能成为这个应用的扩展组件了。

##  开发步骤

完成一个PFF表单的开发通常包括以下步骤：

### 1. 设计表单界面

这一步包括使用所见即所得的界面设计器进行[界面设计](3-2-form)，也包括自定义[动作](3-4-action)的设置，和[引用列表](3-5-reference)的设置。

### 2. 设计数据视图

如果需要使用PFF的数据库引擎，就需要这一步，如果不需要，可以跳过。这一步包括数据表的定义、表间关系和引用的定义、数据绑定等相关内容。详细内容请参考[第三章 表单设计 - 数据视图](3-3-database)。

### 3. 编写脚本

没有脚本的表单几乎没什么用，所以写脚本是必须的。表单、控件、动作、引用列表、数据表都有开放相应的可编程函数，在 biForm 的脚本编辑器中按设置好的模板填写 Python 脚本就可以了。详细内容请参考[脚本编辑](3-6-script)、[表单的公共模块](1-1-public)、[控件的可编程函数](1-4-openscript)、[表单的可编程函数](1-7-formscript)。

### 4. 试运行/测试/调试

在 biForm 中就可以运行表单进行测试和调试。但有些与环境和数据有关的功能可能在 biForm 的试运行环境下不容易进行程序测试和调试，可以先打包成为PFF文件后，在 biReader 等运行时环境下进行测试和调试。详细内容请参考[第四章 测试和调试](4-1-summary)。

### 5. 打包发布

开发完成的表单，打包为PFF文件就可以发布给最终用户了。最终用户使用各种运行时环境（比如 biReader）就可以使用您开发的程序了。详细内容请参考[第五章 应用发布和运行时环境](5-1-runtime)。
