# 表单的可编程函数

biForm 中每个表单都有开放几个可编程函数。用于处理表单加载、运行、关闭等各种事务的处理。

除了“公共模块”没有函数名之外，其它都有对应的函数名。在表单后台的脚本中可以直接通过这些函数名调用这些函数，但一般不建议这样做，这种调用也只会执行函数体中的脚本，并不会影响表单对事件的响应。

## 目录

|    可编程函数    |                              函数名                               |
| --------------- | ---------------------------------------------------------------- |
| 公共模块        | 提供表单级的函数、变量、类定义等<br>参考[表单的公共模块](1-1-public) |
| 加载前          | [form_beforeload](#beforeload)                                    |
| 加载后          | [form_afterload](afterload)                                      |
| 新建空白表单前   | [form_beforecreatenew](beforecreatenew)                          |
| 新建空白表单后   | [form_aftercreatenew](aftercreatenew)                            |
| 保存前          | [form_beforesave](beforesave)                                    |
| 保存后          | [form_aftersave](aftersave)                                      |
| 删除前          | [form_beforedelete](beforedelete)                                |
| 删除后          | [form_afterdelete](afterdelete)                                  |
| 加载数据时       | [form_loaddata](loaddata)                                        |
| 打印前          | [form_before_print](before_print)                                |
| 打印后          | [form_after_print](after_print)                                  |
| 打印参数        | [form_print_args](print_args)                                    |
| 记录别名        | [form_alias](alias)                                              |
| 编号规则        | [form_number](number)                                            |
| 关闭前          | [form_before_print](before_print)                                |
| 关闭后          | [form_after_print](after_print)                                  |
| 单次定时器超时时 | [form_singleshot](singleshot)                                    |
| 定时器超时时     | [form_timeout](timeout)                                                 |
| 全程过滤条件     | [form_filter](filter)                                                  |
| 关联记录        | [form_relativerecord](relativerecord)                                          |

- ### beforeload

**可编程函数：加载前** 

[返回目录](#目录)

|      内容       |                                   说明                                    |
| --------------- | ------------------------------------------------------------------------- |
| 函数名          | form_beforeload                                                           |
| 传入参数        | 无                                                                        |
| 返回值          | 是否允许表单加载                                                           |
| 建议的返回值类型 | 布尔型                                                                    |
| 使用规则        | 加载这个表单之前被调用。如果返回值为 True 表示允许加载，否则表单将不会被加载。 |
|                 | 在调用这个函数前，表单上控件、数据库等都可以访问。                           |
|                | 缺省的返回值是 True 。 不添加自己的脚本的话，返回值也是 True。               |
|                 | 所有类型的表单都会使用这个可编程函数。                                       |

- ### afterload

**可编程函数：加载后** 

[返回目录](#目录)

|      内容       |                                                说明                                                 |
| --------------- | -------------------------------------------------------------------------------------------------- |
| 函数名          | form_afterload                                                                                     |
| 传入参数        | 无                                                                                                  |
| 返回值          | 加载后转到空白记录状态还是转到查询状态                                                                |
| 建议的返回值类型 | 布尔型                                                                                              |
| 使用规则        | 加载这个表单之后被调用。如果返回值为 True 表示加载后创建一条空白记录，否则表单会转到查询现有记录的状态。  |
|                 | 查询状态时缺省是不带过滤条件查询列出所有记录，但只会缓存显示最前一部分记录，排序规则可以在表单选项中设置。 |
|                | 缺省的返回值是 True 。 不添加自己的脚本的话，返回值也是 True。                                         |
|                 | 所有类型的表单都会使用这个可编程函数。                                                                |

- ### beforecreatenew

**可编程函数：新建空白表单前** 

[返回目录](#目录)

|      内容       |                                                                                                         说明                                                                                                          |
| --------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 函数名          | form_beforecreatenew                                                                                                                                                                                                 |
| 传入参数        | 无                                                                                                                                                                                                                   |
| 返回值          | 是否允许表单创建新的空白记录                                                                                                                                                                                           |
| 建议的返回值类型 | 布尔型                                                                                                                                                                                                                |
| 使用规则        | 在创建新的空白表单前被调用。如果返回值为 True 表示允许创建空白记录，表单上各控件将恢复为缺省值，否则表单将保持现有状态。                                                                                                     |
|                | 缺省的返回值是 True 。 不添加自己的脚本的话，返回值也是 True。                                                                                                                                                           |
|                 | 所有类型的表单都会使用这个可编程函数，即使不是用于数据录入的表单。                                                                                                                                                        |
|                 | 但如果非表单的“允许创建空白表单”设为“否”，则不允许用户点击“新建”按钮，也不能通过 this.form.createNew() 来调用这个函数，但可以直接调用 form_createnew() 这个函数，但这种调用只会执行函数内的脚本，不会影响表单状态和控件的初始值。 |

- ### aftercreatenew

**可编程函数：新建空白表单后** 

[返回目录](#目录)

|      内容       |                                     说明                                     |
| --------------- | ---------------------------------------------------------------------------- |
| 函数名          | form_aftercreatenew                                                          |
| 传入参数        | 无                                                                           |
| 返回值          | 无                                                                           |
| 建议的返回值类型 | 无                                                                           |
| 使用规则        | 创建空白记录后被调用。                                                        |
|                 | 调用 form_beforecreatenew 之后，各个控件会被恢复为缺省值，之后就会调用这个函数。 |

- ### beforesave

**可编程函数：保存前** 

[返回目录](#目录)

|      内容       |                                                                                                       说明                                                                                                        |
| --------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 函数名          | form_beforesave                                                                                                                                                                                                  |
| 传入参数        | 无                                                                                                                                                                                                               |
| 返回值          | 是否允许保存当前表单中录入的数据                                                                                                                                                                                    |
| 建议的返回值类型 | 布尔型                                                                                                                                                                                                            |
| 使用规则        | 点击表单上工具栏中“保存”按钮时被调用。如果允许保存，返回 True，否则返回 False。'                                                                                                                                      |
|                | 缺省的返回值是 True 。 不添加自己的脚本的话，返回值也是 True。                                                                                                                                                       |
|                 | 只有设置了“主表”属性，且“允许保存”为“是”的表单才会使用这个可编程函数。                                                                                                                                                |
|                 | 如果非表单的“允许保存”设为“否”，则不允许用户点击“保存”按钮，也不能通过 this.form.save() 来调用这个函数，但可以直接调用 form_beforesave() 这个函数，但这种调用只会执行函数内的脚本，不会执行表单数据引擎内部对数据的保存操作。 |

- ### aftersave

**可编程函数：保存后** 

[返回目录](#目录)

|      内容       |                                                             说明                                                              |
| --------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| 函数名          | form_aftersave                                                                                                               |
| 传入参数        | 无                                                                                                                           |
| 返回值          | 无                                                                                                                           |
| 建议的返回值类型 | 无                                                                                                                           |
| 使用规则        | 只有表单数据保存成功后，才会被调用。                                                                                            |
|                 | 如果非表单的“允许保存”设为“否”，则不允许用户点击“保存”按钮，所以也不会调用这个函数。但程序中可以直接调用 form_aftersave() 这个函数。 |

- ### beforedelete

**可编程函数：删除前** 

[返回目录](#目录)

|      内容       |                                                                                                      说明                                                                                                       |
| --------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 函数名          | form_beforedelete                                                                                                                                                                                               |
| 传入参数        | 无                                                                                                                                                                                                              |
| 返回值          | 是否允许删除当前表单上显示的这条记录                                                                                                                                                                              |
| 建议的返回值类型 | 布尔型                                                                                                                                                                                                          |
| 使用规则        | 点击表单上工具栏中“删除”按钮时被调用。如果允许删除，返回 True，否则返回 False。'                                                                                                                                    |
|                | 缺省的返回值是 True 。 不添加自己的脚本的话，返回值也是 True。                                                                                                                                                     |
|                 | 只有设置了“主表”属性，且“允许删除”为“是”的表单才会使用这个可编程函数。                                                                                                                                              |
|                 | 如果非表单的“允许删除”设为“否”，则不允许用户点击“删除”按钮，也不能通过 this.form.drop() 来调用这个函数，但可以直接调用 form_beforedelete() 这个函数，但这种调用只会执行函数内的脚本，不会执行表单数据引擎对数据的删除操作。 |

- ### afterdelete

**可编程函数：删除后** 

[返回目录](#目录)

|      内容       |                                                           说明                                                            |
| --------------- | ------------------------------------------------------------------------------------------------------------------------- |
| 函数名          | form_afterdelete                                                                                                          |
| 传入参数        | 无                                                                                                                        |
| 返回值          | 无                                                                                                                        |
| 建议的返回值类型 | 无                                                                                                                        |
| 使用规则        | 只有表单当前这条记录删除成功后，才会被调用。                                                                                 |
|                 | 如果非表单的“允许删除”设为“否”，则不允许用户点击“删除”按钮，所以也不会调用这个函数。但可以直接调用 form_afterdelete() 这个函数。 |

- ### loadrecord

**可编程函数：加载数据时** 

[返回目录](#目录)

|      内容       |                                                说明                                                 |
| --------------- | -------------------------------------------------------------------------------------------------- |
| 函数名          | form_loadrecord                                                                                    |
| 传入参数        | 记录的UUID                                                                                          |
| 返回值          | 无                                                                                                  |
| 建议的返回值类型 | 无                                                                                                  |
| 使用规则        | 只有设置了“主表”属性的表单，在从数据库里读取一条主表的记录需要在表单界面显示时才会调用这个函数。          |
|                 | 通常是在使用“查询”功能，列出所有记录，记录定位器转到某条记录时会调用。                                  |
|                 | 在保存一条新添加的记录之后，缺省情况下会重新从数据库里查询出这条新记录，并在表单上显示，也会调用这个函数。 |

在这个函数体内可以通过 this.record 对象，或 record 来访问读取到的主表记录的值。 record 等同于 this.record.data 。this.record 这个对象在表单生存期内会一直存在，在表单显示不同记录时，其属性会按记录的内容进行更新，可以在表单上其它可编程函数中访问。比如本例中的 fauthor_updated 就可以在“保存前”脚本中通过调用它判断现在表单上录入的作者与数据库中原来的“fauthor”这个字段的值是否不同，以判断是否修改过。

假设表单主表为 t_book，还有子表 t_book_d，表结构如下图所示：

![t_book](1-5-01.png)

两表之间通过字段ID，是一对多的关系，关系设置如下图所示：

![relationship](1-5-02.png)

```print(dit(this.record))```将返回以下的结果：

```
['ID', 'ID_updated', 'UUID', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__weakref__', 'data', 'db', 'fISBN', 'fISBN_updated', 'fauthor', 'fauthor_updated', 'fclass', 'fclass_updated', 'fieldList', 'fname', 'fname_updated', 'fyear', 'fyear_updated', 'isEmpty', 'lastUpdated', 'pkName', 'pkValue', 'refresh', 'reset', 'subRecord', 'tableName']
```

|  属性/函数/对象  |                                                                          说明                                                                           |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ID              | 这条记录字段ID的值。在加载某条记录的数据后，这个值会一直保持之前从数据库中读取的记录的值不变，其它字段也是一样。                                                |
| ID_updated      | 这条记录字段ID的值与现在的ID字段“绑定值”返回的值是否相等，如果不等，这个属性值为 True，否则为 False。其它以_updated结尾的属性也是一样的规则。                   |
| fname           | 这条记录字段fname的值                                                                                                                                    |
| fname_updated   | 这条记录字段fname的值与现在的fname字段“绑定值”返回的值是否相等                                                                                              |
| fauthor         | 这条记录字段fauthor的值                                                                                                                                  |
| fauthor_updated | 这条记录字段fauthor的值与现在的fauthor字段“绑定值”返回的值是否相等                                                                                          |
| fclass          | 这条记录字段fclass的值                                                                                                                                   |
| fclass_updated  | 这条记录字段fclass的值与现在的fclass字段“绑定值”返回的值是否相等                                                                                            |
| fyear           | 这条记录字段fyear的值                                                                                                                                    |
| fyear_updated   | 这条记录字段fyear的值与现在的fyear字段“绑定值”返回的值是否相等                                                                                              |
| fISBN           | 这条记录字段fISBN的值                                                                                                                                    |
| fISBN_updated   | 这条记录字段fISBN的值与现在的fISBN字段“绑定值”返回的值是否相等                                                                                              |
| data            | tuple类型的数据，每个元素对应主表 t_book 每个字段的值。                                                                                                    |
|                 | 如: (1, '大河', '佚名', '小说', 2005, 'ISBN:165-699', '{292a97f5-c861-45a7-9c76-f8193162de18}', '2020-10-19 17:02:32')                                   |
|                 | 其中最后两个字段是 biForm 中每个表都会自动添加的字段 UUID 和 lastUpdated                                                                                   |
| db              | 表单的数据库连接对象，调用接口请参考[数据库](1-6-database)                                                                                                 |
| fieldList       | tuple类型的数据，本例中的值就是：('ID', 'fname', 'fauthor', 'fclass', 'fyear', 'fISBN', 'UUID', 'lastUpdated')                                            |
| isEmpty         | 是否是空记录                                                                                                                                             |
| pkName          | 主表的主关键字段的名称，本例就是“ID”                                                                                                                      |
| pkValue         | 用于定位记录的主表的主关键字段的值，注意它并不等于 this.record.ID 的值                                                                                      |
|                 | this.record.ID 是从数据库中查询出来的值，PkValue只是用于定位记录的传入参数                                                                                  |
| refresh         | 重新从数据库中读取这条记录                                                                                                                                |
| reset           | 将各属性值都置为零或空，一般不需要开发者调用，属于内部调用的接口                                                                                             |
| tableName       | 主表的表名，本例就是“t_book”                                                                                                                             |
| subRecord       | 查询返回这个表单的子表与主表关联的记录                                                                                                                     |
|                 | 返回的结果为 list 对象，其中每个元素对应一条记录，每条记录也是一个 list 对象，其中每个元素对应每个字段的值                                                     |
|                 | 比如子表 t_book_d ，与 t_book 是多对一的关系，使用 this.record.subRecord('t_book_d') 返回的结果：                                                    |
|                 | [[1,1,12,'{292a97f5-c861-45a7-9c76-f8193162de18}', '2020-10-19 17:02:32'],<br>[1,2,35,'{292a97f5-c861-45a7-9c76-f8193162de18}', '2020-10-19 17:02:32']] |
